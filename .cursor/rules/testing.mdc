---
description: Testing rules for the application.
globs:
  - "**/*.test.ts"
  - "**/*.spec.ts"
alwaysApply: false
---

# Testing Rules

## Test Organization

### File Structure
```
src/
├── components/
│   ├── UserCard.tsx
│   └── __tests__/
│       └── UserCard.test.tsx
├── hooks/
│   ├── useUser.ts
│   └── __tests__/
│       └── useUser.test.tsx
└── lib/
    ├── utils.ts
    └── __tests__/
        └── utils.test.ts
```

### Test File Naming
```typescript
// ✅ Component tests
UserCard.test.tsx
UserCard.spec.tsx

// ✅ Hook tests
useUser.test.tsx
useUser.spec.tsx

// ✅ Utility tests
utils.test.ts
utils.spec.ts
```

## Jest Configuration

### Setup Files
```typescript
// jest.setup.ts
import '@testing-library/jest-dom'

// Mock Next.js router
jest.mock('next/navigation', () => ({
  useRouter() {
    return {
      push: jest.fn(),
      replace: jest.fn(),
      prefetch: jest.fn(),
      back: jest.fn(),
      forward: jest.fn(),
      refresh: jest.fn(),
    }
  },
  useSearchParams() {
    return new URLSearchParams()
  },
  usePathname() {
    return '/'
  },
}))
```

## Component Testing

### React Testing Library
```typescript
// ✅ Component test with user interactions
import { render, screen, fireEvent } from '@testing-library/react'
import userEvent from '@testing-library/user-event'
import { UserCard } from '../UserCard'

describe('UserCard', () => {
  const mockUser = {
    id: '1',
    name: 'John Doe',
    email: 'john@example.com'
  }

  it('renders user information correctly', () => {
    render(<UserCard user={mockUser} onEdit={jest.fn()} />)
    
    expect(screen.getByText('John Doe')).toBeInTheDocument()
    expect(screen.getByText('john@example.com')).toBeInTheDocument()
  })

  it('calls onEdit when edit button is clicked', async () => {
    const user = userEvent.setup()
    const mockOnEdit = jest.fn()
    
    render(<UserCard user={mockUser} onEdit={mockOnEdit} />)
    
    const editButton = screen.getByRole('button', { name: /edit/i })
    await user.click(editButton)
    
    expect(mockOnEdit).toHaveBeenCalledWith('1')
  })

  it('applies custom className', () => {
    render(
      <UserCard 
        user={mockUser} 
        onEdit={jest.fn()} 
        className="custom-class" 
      />
    )
    
    const card = screen.getByRole('article')
    expect(card).toHaveClass('custom-class')
  })
})
```

### Testing with Providers
```typescript
// ✅ Test with context providers
import { render } from '@testing-library/react'
import { ThemeProvider } from '@/components/theme-provider'

function renderWithProviders(ui: React.ReactElement) {
  return render(
    <ThemeProvider>
      {ui}
    </ThemeProvider>
  )
}

describe('ThemedComponent', () => {
  it('renders with theme context', () => {
    renderWithProviders(<ThemedComponent />)
    // Test implementation
  })
})
```

## Hook Testing

### Custom Hook Tests
```typescript
// ✅ Test custom hooks
import { renderHook, act } from '@testing-library/react'
import { useCounter } from '../useCounter'

describe('useCounter', () => {
  it('initializes with default value', () => {
    const { result } = renderHook(() => useCounter())
    
    expect(result.current.count).toBe(0)
  })

  it('increments counter', () => {
    const { result } = renderHook(() => useCounter(5))
    
    act(() => {
      result.current.increment()
    })
    
    expect(result.current.count).toBe(6)
  })

  it('decrements counter', () => {
    const { result } = renderHook(() => useCounter(5))
    
    act(() => {
      result.current.decrement()
    })
    
    expect(result.current.count).toBe(4)
  })
})
```

## Utility Testing

### Pure Function Tests
```typescript
// ✅ Test utility functions
import { formatCurrency, calculateTotal } from '../utils'

describe('formatCurrency', () => {
  it('formats positive numbers correctly', () => {
    expect(formatCurrency(1234.56)).toBe('$1,234.56')
  })

  it('formats zero correctly', () => {
    expect(formatCurrency(0)).toBe('$0.00')
  })

  it('formats negative numbers correctly', () => {
    expect(formatCurrency(-1234.56)).toBe('-$1,234.56')
  })
})

describe('calculateTotal', () => {
  it('calculates total with tax', () => {
    const items = [
      { price: 10, quantity: 2 },
      { price: 5, quantity: 1 }
    ]
    
    const total = calculateTotal(items, 0.1) // 10% tax
    
    expect(total).toBe(27.5) // (20 + 5) * 1.1
  })
})
```

## API Testing

### Mock API Calls
```typescript
// ✅ Test API integration
import { render, screen, waitFor } from '@testing-library/react'
import { UserList } from '../UserList'

// Mock fetch
global.fetch = jest.fn()

describe('UserList', () => {
  beforeEach(() => {
    jest.clearAllMocks()
  })

  it('fetches and displays users', async () => {
    const mockUsers = [
      { id: '1', name: 'John Doe', email: 'john@example.com' },
      { id: '2', name: 'Jane Smith', email: 'jane@example.com' }
    ]

    ;(fetch as jest.Mock).mockResolvedValueOnce({
      ok: true,
      json: async () => mockUsers
    })

    render(<UserList />)

    await waitFor(() => {
      expect(screen.getByText('John Doe')).toBeInTheDocument()
      expect(screen.getByText('Jane Smith')).toBeInTheDocument()
    })
  })

  it('handles API errors gracefully', async () => {
    ;(fetch as jest.Mock).mockRejectedValueOnce(new Error('API Error'))

    render(<UserList />)

    await waitFor(() => {
      expect(screen.getByText(/error/i)).toBeInTheDocument()
    })
  })
})
```

## Cypress E2E Testing

### Page Object Pattern
```typescript
// ✅ Cypress page object
// cypress/support/pages/UserPage.ts
export class UserPage {
  visit() {
    cy.visit('/users')
  }

  getUserCard(name: string) {
    return cy.get('[data-testid="user-card"]').contains(name)
  }

  clickEditButton(userName: string) {
    this.getUserCard(userName)
      .find('[data-testid="edit-button"]')
      .click()
  }

  fillUserForm(name: string, email: string) {
    cy.get('[data-testid="name-input"]').clear().type(name)
    cy.get('[data-testid="email-input"]').clear().type(email)
  }

  submitForm() {
    cy.get('[data-testid="submit-button"]').click()
  }
}
```

### E2E Test Examples
```typescript
// ✅ Cypress E2E test
// cypress/e2e/users.cy.ts
import { UserPage } from '../support/pages/UserPage'

describe('User Management', () => {
  const userPage = new UserPage()

  beforeEach(() => {
    userPage.visit()
  })

  it('displays user list', () => {
    cy.get('[data-testid="user-card"]').should('have.length.at.least', 1)
  })

  it('creates a new user', () => {
    cy.get('[data-testid="add-user-button"]').click()
    
    userPage.fillUserForm('New User', 'newuser@example.com')
    userPage.submitForm()
    
    cy.get('[data-testid="user-card"]')
      .should('contain', 'New User')
      .and('contain', 'newuser@example.com')
  })

  it('edits existing user', () => {
    userPage.clickEditButton('John Doe')
    
    userPage.fillUserForm('John Updated', 'john.updated@example.com')
    userPage.submitForm()
    
    cy.get('[data-testid="user-card"]')
      .should('contain', 'John Updated')
      .and('not.contain', 'John Doe')
  })
})
```

## Test Data

### Fixtures
```typescript
// ✅ Test data fixtures
// cypress/fixtures/users.json
{
  "users": [
    {
      "id": "1",
      "name": "John Doe",
      "email": "john@example.com",
      "role": "user"
    },
    {
      "id": "2", 
      "name": "Jane Smith",
      "email": "jane@example.com",
      "role": "admin"
    }
  ]
}

// Usage in tests
cy.fixture('users').then((users) => {
  // Use users data
})
```

## Accessibility Testing

### A11y Tests
```typescript
// ✅ Test accessibility
import { render, screen } from '@testing-library/react'
import { axe, toHaveNoViolations } from 'jest-axe'
import { UserCard } from '../UserCard'

expect.extend(toHaveNoViolations)

describe('UserCard Accessibility', () => {
  it('should not have accessibility violations', async () => {
    const { container } = render(
      <UserCard user={mockUser} onEdit={jest.fn()} />
    )
    
    const results = await axe(container)
    expect(results).toHaveNoViolations()
  })

  it('has proper ARIA labels', () => {
    render(<UserCard user={mockUser} onEdit={jest.fn()} />)
    
    expect(screen.getByLabelText(/edit user/i)).toBeInTheDocument()
  })
})
```

## Performance Testing

### Component Performance
```typescript
// ✅ Test component performance
import { render } from '@testing-library/react'
import { UserList } from '../UserList'

describe('UserList Performance', () => {
  it('renders large lists efficiently', () => {
    const largeUserList = Array.from({ length: 1000 }, (_, i) => ({
      id: i.toString(),
      name: `User ${i}`,
      email: `user${i}@example.com`
    }))

    const startTime = performance.now()
    render(<UserList users={largeUserList} />)
    const endTime = performance.now()

    expect(endTime - startTime).toBeLessThan(100) // Should render in < 100ms
  })
})
```

alwaysApply: false
---
